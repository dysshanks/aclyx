name: Update Contributors List

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout all branches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.ref }}

      - name: Generate contributors list (GitHub usernames only)
        id: contributors
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs
          TMP_FILE=$(mktemp)
          git log --all --format='%aE|%ai' >> "$TMP_FILE"
          git log --all --format='%B' \
            | grep -E '^Co-authored-by:' \
            | sed -E 's/^Co-authored-by: .* <(.*)>$/\1/' \
            | while read -r email; do
                echo "$email|$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              done >> "$TMP_FILE"
          awk -F'|' '
          {
            split($1, parts, "@");
            username=parts[1];
            gsub(/^.*:/, "", username);
            if (username != "") {
              date=$2;
              if (!(username in first_commit) || date < first_commit[username]) {
                first_commit[username]=date;
              }
            }
          }
          END {
            for (u in first_commit)
              print first_commit[u], u;
          }' "$TMP_FILE" | sort | awk '{print $2}' > docs/CONTRIBUTORS
          rm -f "$TMP_FILE"
          chmod 644 docs/CONTRIBUTORS
          cat docs/CONTRIBUTORS

      - name: Commit and push updates
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git diff --quiet docs/CONTRIBUTORS; then
            echo "No changes to contributors list."
          else
            git add docs/CONTRIBUTORS
            git commit -m "chore: update CONTRIBUTORS list"
            git push origin HEAD:${GITHUB_REF}
          fi
