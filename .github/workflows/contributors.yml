name: Update Contributors List

permissions:
  contents: write

on:
  push:

jobs:
  update-contributors:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure docs directory exists
        run: mkdir -p docs

      - name: Install GitHub CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          curl -sSL https://github.com/cli/cli/releases/download/v2.56.0/gh_2.56.0_linux_amd64.tar.gz | tar xz
          sudo mv gh_2.56.0_linux_amd64/bin/gh /usr/local/bin/gh

      - name: Generate contributors list (append new only)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          file="docs/CONTRIBUTORS"
          if [ ! -f "$file" ]; then
            echo "# Project Contributors" > "$file"
            echo "" >> "$file"
          fi

          git log --all --pretty=format:"%an" -- . ':(exclude).github/workflows' \
            | awk '!seen[$0]++ {print $0}' > all_contributors.txt

          gh pr list --state all --json author \
            | jq -r '.[] | .author.login' >> all_contributors.txt

          git log --all --pretty=format:"%b" \
            | grep -i "Co-authored-by:" \
            | sed -E 's/Co-authored-by:\s*([^<]+).*/\1/' >> all_contributors.txt

          sort all_contributors.txt | uniq | while read -r contributor; do
            if ! grep -Fxq "- $contributor" "$file"; then
              echo "- $contributor" >> "$file"
            fi
          done

          rm -f all_contributors.txt

      - name: Commit and push changes
        run: |
          if [[ -n "$(git status --porcelain docs/CONTRIBUTORS)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add docs/CONTRIBUTORS
            git commit -m "chore: update contributors list [skip ci]"
            git push
          else
            echo "No changes to commit."
