- name: Generate contributors list (first commit date)
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    echo "# Project Contributors" > docs/CONTRIBUTORS
    echo "" >> docs/CONTRIBUTORS

    git log --all --reverse --pretty=format:"%an|%ae|%ai" -- . ':(exclude).github/workflows' > all_commits.txt

    awk -F'|' '!seen[$2]++ {print $2 "|" $1 "|" $3}' all_commits.txt > contributors_raw.txt

    grep -i "Co-authored-by:" all_commits.txt | \
    sed -E 's/Co-authored-by:\s*([^<]+).*/\1/' | \
    while read -r coauthor; do
      date=$(git log --all --reverse --pretty=format:"%ai|%an" --author="$coauthor" | head -n1 | cut -d'|' -f1)
      if [ -z "$date" ]; then
        date="2000-01-01 00:00:00"
      fi
      echo "$coauthor|$coauthor|$date" >> contributors_raw.txt
    done

    gh pr list --state all --json author,createdAt \
      | jq -r '.[] | "\(.author.login)|\(.author.login)|\(.createdAt)"' >> contributors_raw.txt

    # sort contributors by date (3rd field) then remove duplicates by author (1st field)
    sort -t'|' -k3,3 contributors_raw.txt | awk -F'|' '!seen[$1]++ {print $1 "|" $3}' \
    | while IFS='|' read -r author date; do
        formatted_date=$(date -d "$date" +"%b %d, %Y" 2>/dev/null || echo "$date")
        echo "- $author ($formatted_date)" >> docs/CONTRIBUTORS
      done

    echo "" >> docs/CONTRIBUTORS
    echo "_Automatically generated by GitHub Actions_" >> docs/CONTRIBUTORS

    rm -f all_commits.txt contributors_raw.txt
